<?php

/**
 * @file
 * Contains Drupal\koba_booking\koba_booking.module
 */

/**
 * @defgroup koba_booking
 * @{
 * Implement a Content entity.
 *
 * }
 */

use Drupal\Core\Form\FormStateInterface;
use Drupal\file\Entity\File;
use Drupal\Core\Config;


/**
 * Implements hook_theme().
 */
function koba_booking_theme() {
  return array(
    'booking_calendar_page' => array(
      'variables' => array(),
      'file' => 'koba_booking.pages.inc',
    ),
    'booking_receipt' => array(
      'variables' => array(),
      'file' => 'koba_booking.pages.inc',
    ),
    'booking_add_booking' => array(
      'render element' => 'form',
    ),
  );
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function koba_booking_form_koba_booking_booking_form_alter(&$form, FormStateInterface $form_state, $form_id) {

  // Switch between add or edit action.
  if ($form['#action'] == '/booking/add') {

    // Fetch module config settings.
    $config = \Drupal::config('koba_booking.settings');

    // Fetch header top file.
    $top_image_id = $config->get('koba_booking.create_booking_top_image', '');
    $file = ($top_image_id) ? File::load($top_image_id) : FALSE;

    // @todo caching af image.
    // Set variables
    $form['variables']['title'] = $config->get('koba_booking.create_booking_title', '');
    $form['variables']['top_img'] = ($file) ? $file->url() : '';
    $form['variables']['manchet'] = $config->get('koba_booking.create_booking_description', '');

    // Add template as prefix.
    $form['#theme'] = array('booking_add_booking');


    $form['booking_status']['#access'] = FALSE;

    // Set default value to now.
    $form['booking_from_date']['widget']['0']['value']['#default_value'] = date('d/m/Y', time());
  }
  else {

    // Set date format from timestamp.
    $from_stamp = $form['booking_from_date']['widget']['0']['value']['#default_value'];
    $to_stamp = $form['booking_to_date']['widget']['0']['value']['#default_value'];

    // Set the default date value in the the edit form.
    $form['booking_from_date']['widget']['0']['value']['#default_value'] = date('d/m/Y', $from_stamp);
  }

  // Enable jquery calendar for date fields.
  $form['booking_from_date']['widget']['0']['value']['#attributes']['class']['0'] = 'js-datepicker';
  $form['booking_from_date']['widget']['0']['value']['#title'] = t('Date');
  $form['booking_from_date']['widget']['0']['value']['#attributes']['readonly'] = 'readonly';

  // Disable the two datefield (The actual date value saved in the DB is generated in the form submit handler).
  $form['booking_to_date']['#access'] = FALSE;


  // Add custom fields for to and from time based on from and to timestamps.
  // We want the database to save two timestamps (From and two), but these timestamps should be generated from three input fields (Date, toTime and fromTime).
  $form['booking_from_time'] = array(
    '#type' => 'textfield',
    '#title' => t('From'),
    '#default_value' => ($form['#action'] == '/booking/add') ? '06:00' : date('H:i', $from_stamp),
    '#size' => 60,
    '#maxlength' => 128,
    '#attributes' => array(
      'class' => array('js-timepicker'),
      'readonly' => 'readonly'
    ),
  );

  $form['booking_to_time'] = array(
    '#type' => 'textfield',
    '#title' => t('To'),
    '#default_value' => ($form['#action'] == '/booking/add') ? '06:00' : date('H:i', $to_stamp),
    '#size' => 60,
    '#maxlength' => 128,
    '#attributes' => array(
      'class' => array('js-timepicker'),
      'readonly' => 'readonly'
    ),
  );
}


